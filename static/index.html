<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ö–æ—Ä–æ–±–∫–∞ —Å –º–∏—Å–∏–∫—Å–∞–º–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  <style>
    .fade-in  { animation: fade-in  .25s ease forwards; }
    .fade-out { animation: fade-out .25s ease forwards; }
    @keyframes fade-in  { from{opacity:0; transform:scale(.97)} to{opacity:1; transform:scale(1)} }
    @keyframes fade-out { from{opacity:1; transform:scale(1)}  to{opacity:0; transform:scale(.97)} }
  </style>
</head>
<body class="bg-gray-50 min-h-screen grid place-items-center">
  <div class="w-full max-w-2xl p-6">
    <!-- –®–∞–≥ 1: –ö–æ—Ä–æ–±–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
    <button id="boxBtn"
      class="w-full aspect-video rounded-3xl bg-white shadow grid place-items-center hover:shadow-lg transition-shadow">
      <div id="boxLottie" class="w-48 h-48"></div>
      <div class="text-sm text-gray-500 mt-2">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    </button>

    <!-- –®–∞–≥ 2: –ü–µ—Ä—Å–æ–Ω–∞–∂ + –≤–≤–æ–¥ (—Å–∫—Ä—ã—Ç–æ –¥–æ –∫–ª–∏–∫–∞) -->
    <section id="chatStage" class="hidden mt-6 space-y-4">
      <div class="rounded-3xl bg-white shadow p-5 flex items-center gap-4">
        <div id="charLottie" class="w-28 h-28"></div>
        <div class="text-sm text-gray-600" id="charHint">–ü—Ä–∏–≤–µ—Ç! –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å üôÇ</div>
      </div>

      <form id="askForm" class="flex gap-2">
        <input id="promptInput" type="text" placeholder="–°–∫–æ–ª—å–∫–æ —á—É–¥–µ—Å —Å–≤–µ—Ç–∞ –≤ –º–∏—Ä–µ?"
               class="flex-1 rounded-2xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
               required />
        <button class="rounded-2xl bg-blue-600 text-white px-5 py-3 hover:bg-blue-700 disabled:opacity-50">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
      </form>

      <div id="status" class="text-sm text-gray-500"></div>

      <article id="answerCard"
        class="hidden rounded-3xl bg-white shadow p-5 prose prose-sm max-w-none"></article>
    </section>
  </div>

<script>
  // ====== Lottie setup ======
  const boxLottie = lottie.loadAnimation({
    container: document.getElementById('boxLottie'),
    renderer: 'svg', loop: true, autoplay: true,
    path: '/static/assets/box.json' // –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π —Ñ–∞–π–ª/–≥–∏—Ñ
  });

  const charContainer = document.getElementById('charLottie');
  let charAnimIdle, charAnimThink, currentAnim = null;

  function loadCharAnims() {
    // idle
    charAnimIdle = lottie.loadAnimation({
      container: charContainer, renderer: 'svg', loop: true, autoplay: false,
      path: '/static/assets/character_idle.json'
    });
    // think (–ø–æ–≤–µ—Ä—Ö idle ‚Äì –ø–æ —Ñ–∞–∫—Ç—É –±—É–¥–µ–º –ø–æ–¥–º–µ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º—ã–º)
    charAnimThink = lottie.loadAnimation({
      container: charContainer, renderer: 'svg', loop: true, autoplay: false,
      path: '/static/assets/character_think.json'
    });
    // –Ω–∞—á–Ω—ë–º —Å idle
    playAnim('idle');
  }

  function playAnim(mode) {
    // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω—É–∂–Ω—É—é
    [charAnimIdle, charAnimThink].forEach(a => a && a.stop());
    if (mode === 'think' && charAnimThink) { charAnimThink.play(); currentAnim = 'think'; return; }
    if (charAnimIdle) { charAnimIdle.play(); currentAnim = 'idle'; }
  }

  // ====== DOM refs ======
  const boxBtn     = document.getElementById('boxBtn');
  const chatStage  = document.getElementById('chatStage');
  const askForm    = document.getElementById('askForm');
  const promptIn   = document.getElementById('promptInput');
  const statusEl   = document.getElementById('status');
  const answerCard = document.getElementById('answerCard');
  const charHint   = document.getElementById('charHint');

  function setStatus(msg, kind='info') {
    statusEl.textContent = msg || '';
    statusEl.className = 'text-sm ' + (kind === 'error' ? 'text-red-600' : 'text-gray-500');
  }

  function md(html) {
    return DOMPurify.sanitize(marked.parse(html || ''));
  }

  // ====== Flow ======
  boxBtn.addEventListener('click', () => {
    // —Å–ø—Ä—è—Ç–∞—Ç—å –∫–æ—Ä–æ–±–∫—É ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ü–µ–Ω—É —á–∞—Ç–∞
    boxBtn.classList.add('fade-out');
    setTimeout(() => {
      boxBtn.classList.add('hidden');
      chatStage.classList.remove('hidden');
      chatStage.classList.add('fade-in');
      loadCharAnims();
      promptIn.focus();
    }, 250);
  });

  askForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const prompt = promptIn.value.trim();
    if (!prompt) return;

    // UI –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    setStatus('–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º‚Ä¶');
    answerCard.classList.add('hidden');
    answerCard.innerHTML = '';
    charHint.textContent = '–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º‚Ä¶';
    playAnim('think');
    askForm.querySelector('button').disabled = true;

    try {
      const resp = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, stream: false })
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${resp.status}`);
      }
      const data = await resp.json(); // { content }
      // –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
      answerCard.innerHTML = md(data.content);
      answerCard.classList.remove('hidden');
      answerCard.classList.add('fade-in');
      setStatus('');
      charHint.textContent = '–ì–æ—Ç–æ–≤–æ!';
    } catch (err) {
      setStatus(
        err.message?.includes('no_responsive_model')
          ? '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –º–æ–¥–µ–ª–∏. –û—Ç–∫—Ä–æ–π LM Studio ‚Üí Server ‚Üí Start Server –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å.'
          : `–û—à–∏–±–∫–∞: ${err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}`,
        'error'
      );
      charHint.textContent = '–£–ø—Å‚Ä¶ –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë?';
    } finally {
      // –ø–µ—Ä—Å–æ–Ω–∞–∂ ¬´–ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –¥—É–º–∞—Ç—å¬ª; –º–æ–∂–Ω–æ —Å–ø—Ä—è—Ç–∞—Ç—å –µ–≥–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      playAnim('idle');
      askForm.querySelector('button').disabled = false;
    }
  });
</script>
</body>
</html>
